#define F_CPU 16000000UL
#include <avr/io.h>
#include <avr/interrupt.h>
#include <util/delay.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>


// CONTROLE DO MOTOR (PWM)
void configurar_motor(void) {
    
    DDRB |= (1 << PB1);                    // PB1 = Arduino D9 (saída PWM)
    TCCR1A = (1 << WGM10) | (1 << COM1A1); // Fast PWM 8-bit, não-invertido  256
    TCCR1B = (1 << WGM12) | (1 << CS11);   // Prescaler 8  f +- 7.8khz
    OCR1A = 0;                             // Duty inicial 0% (motor parado)
}

void ajustar_velocidade_motor(uint8_t velocidade) {
    //define razão de ciclo PWM de 0 a 100%
    //proteção contra valores inválidos
    if (velocidade > 100) velocidade = 100; //limita a 100%
    OCR1A = (velocidade * 255UL) / 100;     //converte % para valor PWM
}

// SENSOR DE ROTAÇÃO (RPM) 
volatile uint32_t total_pulsos = 0;           // Contador de pulsos
volatile uint8_t flag_medir_rpm = 0;          // Flag para cálculo do RPM
volatile uint16_t pulsos_ultimo_periodo = 0;  // Pulsos no último intervalo

ISR(INT1_vect) {
   
    // Interrupção do sensor - PD3 (INT1)
    total_pulsos++;  // Incrementa a cada pulso do sensor
}

void configurar_sensor_rotacao(void) {
  //Configura sensor no pino PD3 (Arduino D3)
    DDRD &= ~(1 << PD3);     // PD3 como entrada
    PORTD |= (1 << PD3);     // Ativa pull-up interno
    EICRA |= (1 << ISC11);   // Interrupção na borda de descida
    EICRA &= ~(1 << ISC10);
    EIMSK |= (1 << INT1);    // Habilita INT1
}

// TEMPORIZADOR PARA MEDIÇÃO - 
void iniciar_temporizador_medicao(void) {
    //Timer para medição periódica (1 segundo)
    TCCR2A = (1 << WGM21);    // Modo CTC
    TCCR2B = (1 << CS22);     // Prescaler 64
    OCR2A = 249;              // 1ms (16MHz/64/250)
    TIMSK2 |= (1 << OCIE2A);  // Habilita interrupção
}

volatile uint16_t contador_tempo = 0;

ISR(TIMER2_COMPA_vect) {
   //Periodicidade de 1 segundo para envio de informações
    contador_tempo++;
    if (contador_tempo >= INTERVALO_MEDICAO) {  // 1000ms = 1 segundo
        contador_tempo = 0;
        pulsos_ultimo_periodo = total_pulsos;  // Salva pulsos do último segundo
        total_pulsos = 0;                      // Zera para próximo segundo
        flag_medir_rpm = 1;                    // Sinaliza cálculo do RPM
    }
}



int main(void) {

    while (1) {

    }
    return 0;
}